name: C/C++ CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y clang cmake ninja-build lcov

    - name: Configure CMake (with coverage)
      run: |
        cmake -B build \
          -DCMAKE_C_COMPILER=gcc-14 \
          -DCMAKE_CXX_COMPILER=g++-14 \
          -DSANITIZE=OFF \
          -DTRACY_ENABLE=OFF \
          -DCOVERAGE=ON

    - name: Build
      run: cmake --build build

    - name: Run Tests
      run: ./build/tests

    - name: Generate Coverage (lcov)
      run: |
        # Capture coverage using ONLY gcov-14
        lcov \
          --gcov-tool gcov-14 \
          --capture \
          --directory build \
          --output-file coverage.info \
          --ignore-errors mismatch \
          --ignore-errors negative \
          --rc geninfo_unexecuted_blocks=1

        # Remove unwanted files
        lcov \
          --remove coverage.info \
          "/usr/*" \
          "*/googletest/*" \
          "*/gtest/*" \
          "*/CMakeFiles/*" \
          --output-file coverage.info

        # Generate HTML report
        genhtml coverage.info --output-directory coverage_html

    - name: Enforce 95% Coverage Threshold
      run: |
        # Extract the line coverage percentage from lcov output
        COVERAGE=$(lcov --summary coverage.info | grep "lines......:" | awk '{print $2}' | sed 's/%//')

        echo "Line coverage: ${COVERAGE}%"

        # Fail if below threshold
        THRESHOLD=95
        awk -v c="$COVERAGE" -v t="$THRESHOLD" 'BEGIN { exit (c < t) }'